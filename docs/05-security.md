# セキュリティ要件

本ドキュメントは、[08-workflow.md](./08-workflow.md) のワークフロー実装に必要なセキュリティ仕様を定義します。

---

## 認証・認可

### ユーザー認証（第1章：ユーザー登録・審査関連）

#### パスワード管理
- **最小文字数**: 8文字以上
- **複雑性要件**: 大文字、小文字、数字、特殊文字を含む
- **ハッシング**: bcrypt (cost: 12)で安全にハッシング化
- **有効期限**: パスワード変更推奨期間 90 日
- **履歴管理**: 過去 5 世代のパスワードは再利用不可

#### セッション管理
- **トークン方式**: JWT (JSON Web Token)
- **有効期限**:
  - アクセストークン: 15 分
  - リフレッシュトークン: 7 日
- **ログアウト**: トークンブラックリスト化
- **複数デバイス対応**: 複数セッション同時管理可能（最大 5 セッション）
- **セッション監視**: 異常ログイン検出

#### OAuth 認証（Google、Facebook、Instagram など）
- OAuth 2.0 フロー対応
- リフレッシュトークン管理
- スコープの最小化原則
- トークン有効期限管理

### 権限管理（企業担当者の複数権限設定）

#### ロールベースアクセス制御（RBAC）
- **企業ロール**:
  - 管理者: 全機能アクセス可能
  - プロジェクト担当: プロジェクト・マッチング管理のみ
  - 経理担当: 請求・支払い管理のみ
  - 閲覧権限: 情報閲覧のみ

- **インフルエンサーロール**:
  - 基本ロール: 案件検索・応募・納品
  - (複数担当者管理なし)

- **管理者ロール**:
  - システム管理者: 全システムアクセス可能

#### エンドポイント毎の権限検証
- すべてのエンドポイントで権限チェック実装
- 権限なしアクセスは 403 Forbidden
- 権限変更時はセッション更新

---

## データ保護

### 通信セキュリティ

#### HTTPS/TLS
- **必須**: すべての通信は HTTPS で暗号化
- **TLS バージョン**: TLS 1.2 以上（推奨: TLS 1.3）
- **証明書**: Let's Encrypt または商用 CA
- **HST**: HTTP Strict-Transport-Security ヘッダー設定

#### セキュアクッキー
- **HttpOnly フラグ**: JavaScript アクセス不可
- **Secure フラグ**: HTTPS 通信時のみ送信
- **SameSite**: Strict または Lax

#### CORS設定
- **許可オリジン**: 本番環境 URL のみ
- **許可メソッド**: GET, POST, PUT, DELETE, PATCH のみ
- **許可ヘッダー**: Content-Type, Authorization など必要なもののみ
- **認証情報**: credentials: 'include' で制限

### データ暗号化

#### 保存時暗号化
- **パスワード**: bcrypt ハッシング
- **機密情報**: AES-256 暗号化
  - SNS アクセストークン
  - 銀行口座情報
  - クレジットカード情報（本保存禁止）

#### 転送時暗号化
- **TLS/SSL**: すべてのデータ転送を暗号化

#### データベース暗号化
- **PostgreSQL**: ssl_connection を有効化
- **バックアップ**: 暗号化済みで保存

### データ保持ポリシー

#### ユーザーデータ削除
- **退会時**: 個人情報は 30 日後に削除
- **論理削除**: deleted_at で管理（監査用）
- **物理削除**: 定期バッチで完全削除

#### ログ保持
- **セキュリティログ**: 1 年間保持
- **アクセスログ**: 3 ヶ月保持
- **削除ログ**: 完全な証跡として 1 年間保持

#### バックアップ
- **定期バックアップ**: 1 日 1 回
- **異地保管**: 別リージョンに保存
- **復旧テスト**: 月 1 回実施

---

## 入力検証・XSS対策

### 入力バリデーション

#### クライアント側
- **リアルタイム検証**: 入力フォームで即座の検証
- **UI フィードバック**: ユーザーへの分かりやすい説明
- **形式チェック**: メール形式、URL 形式など

#### サーバー側（必須）
- **必ず再検証**: クライアント検証を過信しない
- **ホワイトリスト方式**: 許可された形式のみを受け入れ
- **サイズ制限**: リクエストボディ（10 MB 以下）
- **レート制限**: 短時間の大量リクエストを遮断

#### バリデーション対象
- メールアドレス: 正当な形式か
- 電話番号: 国別フォーマット対応
- URL: 正当な URL か
- ファイルアップロード: MIME タイプ、ファイルサイズ
- 数値: 範囲外の値は拒否

### XSS（クロスサイトスクリプティング）対策

#### 出力エスケープ
- **HTML エスケープ**: すべてのユーザー入力を HTML エスケープ
- **JavaScript エスケープ**: JSON データをエスケープ
- **URL エスケープ**: URL パラメータをエスケープ

#### Content Security Policy（CSP）
- **CSP ヘッダー設定**:
  ```
  Content-Security-Policy:
    default-src 'self';
    script-src 'self' 'nonce-{random}';
    style-src 'self' 'unsafe-inline';
    img-src 'self' https:;
    font-src 'self';
    connect-src 'self' https://api.example.com;
  ```

#### サニタイズ
- **リッチテキスト入力**: DOMPurify で許可タグのみ抽出
- **マークダウン**: markdown-it で安全な HTML に変換
- **JSON**: strict JSON パーサーで検証

### 特殊文字処理

#### データベース
- **SQL インジェクション対策**: Prisma ORM（パラメータ化クエリ自動生成）
- **動的クエリ禁止**: 文字列連結でのクエリ作成禁止

#### コマンドインジェクション対策
- **exec/spawn**: 絶対に user input を渡さない
- **shell escape**: 必要な場合は shlex.quote() 使用

---

## CSRF対策

### CSRF トークン
- **Form リクエスト**: CSRF トークン検証
- **トークン生成**: セッションごとに一意のトークン（暗号生成）
- **有効期限**: トークンの適切な有効期限設定（1 時間）
- **トークン再生成**: ログイン時・重要操作時

### SameSite クッキー
- **SameSite=Strict** または **SameSite=Lax** を使用
- 形式:
  ```
  Set-Cookie: session_id=...; SameSite=Strict; HttpOnly; Secure
  ```

### 重要操作への対応
- **追加認証**: パスワード変更・口座変更時は再認証
- **確認メール**: 重要操作時にメール認証を追加

---

## SQL インジェクション対策

### クエリ作成

#### Prisma ORM（推奨）
- パラメータ化クエリを自動生成
- ユーザー入力と SQL を分離

```typescript
// Good
const users = await prisma.user.findMany({
  where: { email: userInput }
});

// Bad - 絶対にしない
const query = `SELECT * FROM users WHERE email = '${userInput}'`;
```

#### 入力検証
- **型チェック**: TypeScript で型安全性確保
- **範囲チェック**: ID の値が妥当か
- **フォーマット検証**: メール、URL など

---

## レート制限

### API レート制限

#### 認証済みユーザー
- **一般エンドポイント**: 1,000 リクエスト / 1 時間
- **検索エンドポイント**: 500 リクエスト / 1 時間
- **アップロード**: 10 リクエスト / 1 時間

#### 非認証ユーザー
- **全エンドポイント**: 100 リクエスト / 1 時間
- **ログイン試行**: 5 回 / 15 分（IP 単位）

#### 機密操作の厳しい制限
- **ログイン試行**: 5 回 / 15 分 → ロック 1 時間
- **パスワードリセット**: 3 回 / 1 時間
- **メール認証**: 3 回 / 1 時間

### IP ブラックリスト機能

#### 自動ブロック
- **異常ログイン試行**: 30 分間に 10 回失敗 → IP ブロック
- **高速スキャン**: 1 分間に 100 リクエスト → IP ブロック
- **ブロック期間**: 24 時間

#### 手動ブロック
- **管理者による手動ブロック**: 即座に適用
- **一時的ブロック**: 期間指定可能（最大 7 日）
- **永続ブロック**: 悪質なユーザー対応

#### ホワイトリスト
- **信頼できる IP**: レート制限の除外
- **開発環境**: localhost は除外
- **社内ネットワーク**: 会社 IP を除外

---

## ログ・監査

### セキュリティログ

#### 記録対象
- **ログイン/ログアウト**: ユーザー、IP、デバイス、時刻
- **管理者操作**: ユーザー追加・削除、権限変更
- **データアクセス**: 誰がいつどのデータにアクセスしたか
- **権限変更**: ロール変更の全履歴
- **支払い・振込**: 金銭取引の全記録
- **契約署名**: NDA 署名者、署名時刻

#### ログレベル
- **ERROR**: エラー発生時は必ず記録
- **WARN**: 異常ログイン試行など
- **INFO**: 重要な操作
- **DEBUG**: 開発環境のみ

#### ログ保存・管理
- **ログ保存期間**: 1 年間
- **改ざん防止**: ログの変更不可（アペンドオンリー）
- **暗号署名**: ログチェーンで改ざん検出
- **外部送信**: Sentry で一元管理

### アラート機能

#### リアルタイムアラート
- **異常ログイン**: 新しい場所からのログイン
- **大量データアクセス**: 通常以上の量のデータ取得
- **管理者操作**: 重要な管理操作実行
- **支払い・振込**: 大きな金額の取引

#### アラート通知
- **メール通知**: 管理者に即座に通知
- **Slack 連携**: チャットボットで通知（オプション）
- **ダッシュボード表示**: リアルタイム表示

#### 対応フロー
- **確認**: 不正でないか確認
- **調査**: ログを確認して原因特定
- **対応**: ユーザー連絡、ブロック判定

---

## API セキュリティ

### API キー管理

#### API キー生成
- **ユーザー生成**: 管理画面から生成可能
- **形式**: ランダムな 32 文字以上
- **複数キー**: ユーザーごとに最大 5 キー生成可能
- **キーローテーション**: 90 日ごとの更新推奨

#### API キー有効期限
- **デフォルト**: 1 年
- **カスタム設定**: ユーザーが期限指定可能
- **期限切れ**: 自動的に無効化
- **失効通知**: メール通知

#### スコープ制限
- **API キーごとに機能限定**: 読み取り専用 vs フルアクセス
- **エンドポイント制限**: 特定エンドポイントのみアクセス可
- **IP 制限**: 許可 IP アドレスの設定

### エラーハンドリング

#### 詳細情報の漏洩防止
- **ユーザーへ**: 一般的なエラーメッセージのみ
- **ログへ**: 詳細情報を記録
- **スタックトレース**: 本番環境では非表示

#### エラーレスポンス例
```json
{
  "error": {
    "code": "VALIDATION_ERROR",
    "message": "入力値が正しくありません",
    "statusCode": 400
  }
}
```

#### ログへの詳細記録
```
ERROR: User registration validation failed
Details: Email format invalid (user@invalid), IP: 192.168.1.1
Timestamp: 2025-11-30 10:30:45 UTC
```

---

## 支払い情報セキュリティ

### PCI DSS コンプライアンス

#### クレジットカード情報
- **直接保存禁止**: クレジットカード情報を直接保存しない
- **Stripe 連携**: Stripe で安全に処理
- **トークン化**: カード情報は Stripe トークンで管理

#### 支払い情報の安全な処理
- **暗号化送信**: HTTPS 必須
- **Stripe Checkout**: Stripe ホストの決済ページ利用
- **WebHook 検証**: Stripe からの通知を署名検証

### 振込・支払い情報セキュリティ

#### 銀行口座情報
- **暗号化保存**: AES-256 で暗号化
- **マスク表示**: UI では最後 4 桁のみ表示
- **アクセス制限**: 経理担当と管理者のみアクセス可

#### 支払いワークフロー（第7章）
- **振込前確認**: 管理者による二重確認
- **支払い方法**: 銀行振込のみ（要件定義通り）
- **監査ログ**: すべての振込記録
- **失敗時対応**: 自動リトライ + メール通知

---

## 依存関係管理

### パッケージセキュリティ

#### 脆弱性チェック
- **npm audit**: 定期的に脆弱性チェック
- **Snyk 連携**: 自動で脆弱性検出
- **GitHub Security alerts**: 依存関係の監視

#### 自動更新
- **セキュリティアップデート**: 優先的に適用
- **メジャー更新**: テスト後に適用
- **マイナー更新**: 自動適用

#### ロック管理
- **package-lock.json**: 本番環境で固定バージョン使用
- **npm ci**: npm install ではなく npm ci を使用

---

## インシデント対応

### セキュリティインシデント

#### 検出・報告
- **セキュリティチーム**: 専任チーム設置
- **報告体制**: 全スタッフが報告可能
- **緊急連絡先**: 責任者の連絡先を周知

#### 対応計画
- **インシデント分類**: 重大度レベルを定義
- **対応手順**: ドキュメント化・演習
- **復旧計画**: RTO（復旧目標時間）、RPO（復旧目標地点）を定義

#### ユーザー通知
- **影響を受けたユーザー**: 個別に迅速に通知
- **通知内容**: 事実、対応状況、ユーザーの対応方法
- **公開情報**: ステータスページで透明性確保

#### 原因分析
- **事後分析**: インシデント 48 時間以内に開始
- **報告書**: 原因、対応、再発防止策をまとめる
- **改善実施**: 報告書に基づいて対策実装

---

## コンプライアンス

### 個人情報保護

#### GDPR対応（EU ユーザー）
- **個人データ処理**: GDPR に基づき適切に処理
- **同意管理**: 明示的な同意を取得
- **削除権**: 「忘れられる権利」に対応
- **データポータビリティ**: ユーザーデータのエクスポート機能

#### 日本の個人情報保護法
- **個人情報の安全な管理**: 適切なセキュリティ対策
- **利用目的の明確化**: 利用規約で明記
- **第三者提供の制限**: 事前同意が必要

#### 利用規約・プライバシーポリシー
- **明確な記載**: 個人データの利用について詳細に記載
- **ユーザーの同意**: 利用開始前に同意取得
- **更新時通知**: ポリシー変更時に事前通知

### 定期的な監査

#### セキュリティ監査
- **内部監査**: 3 ヶ月ごと
- **外部監査**: 年 1 回以上
- **監査項目**: データ保護、アクセス制御、ログ管理など

#### ペネトレーション テスト
- **実施頻度**: 年 2 回以上
- **対象**: 全システム・API
- **報告**: 脆弱性の報告・修正・確認

#### コンプライアンスチェック
- **法令対応**: GDPR、個人情報保護法への対応確認
- **業界標準**: PCI-DSS、ISO 27001 への適合確認

---

## セキュリティ体制

### セキュリティチーム
- **責任者**: CTO または専任セキュリティ責任者
- **メンバー**: バックエンド、インフラエンジニア
- **定期会議**: 月 1 回のセキュリティミーティング

### インシデント対応チーム
- **構成**: エンジニア、運用、カスタマーサポート
- **連絡体制**: 24/7 対応体制
- **訓練**: 半年ごとにインシデント対応訓練

### 継続的改善
- **セキュリティ文化**: 全スタッフがセキュリティ意識を持つ
- **研修**: 年 2 回のセキュリティ研修
- **アップデート**: 新しい脅威情報に対応

---

**最終更新**: 2025-11-30
**関連ドキュメント**: [08-workflow.md](./08-workflow.md)、[03-tech-stack.md](./03-tech-stack.md)
