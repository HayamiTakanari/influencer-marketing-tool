(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[8180],{22:function(e,t,r){(window.__NEXT_P=window.__NEXT_P||[]).push(["/chat",function(){return r(762)}])},762:function(e,t,r){"use strict";r.r(t);var s=r(5893),n=r(7294),a=r(5841),l=r(1163),i=r(1664),d=r.n(i),o=r(7642);t.default=()=>{let[e,t]=(0,n.useState)(null),[r,i]=(0,n.useState)([]),[c,u]=(0,n.useState)(null),[m,x]=(0,n.useState)([]),[h,f]=(0,n.useState)(""),[g,p]=(0,n.useState)(!0),[b,v]=(0,n.useState)(""),[j,N]=(0,n.useState)(!1),[w,y]=(0,n.useState)(!1),[I,S]=(0,n.useState)(null),[C,k]=(0,n.useState)(new Set),E=(0,n.useRef)(null),D=(0,n.useRef)(null),R=(0,l.useRouter)();(0,n.useEffect)(()=>{let e=localStorage.getItem("user"),r=localStorage.getItem("token");if(e&&r){let s=JSON.parse(e);t(s);let n=(0,o.io)("http://localhost:10000/api",{auth:{token:r}});S(n),n.on("connect",()=>{console.log("Connected to WebSocket"),n.emit("user-online")}),n.on("new-message",e=>{x(t=>[...t,e]),i(t=>t.map(t=>t.id===e.projectId?{...t,messages:[e],unreadCount:t.unreadCount+1}:t))}),n.on("user-typing",e=>{let{userId:t,projectId:r}=e;(null==c?void 0:c.id)===r&&t!==s.id&&y(!0)}),n.on("user-stop-typing",e=>{let{userId:t,projectId:r}=e;(null==c?void 0:c.id)===r&&t!==s.id&&y(!1)}),n.on("messages-read",e=>{let{projectId:t,readBy:r}=e;(null==c?void 0:c.id)===t&&x(e=>e.map(e=>e.senderId===s.id?{...e,isRead:!0}:e))}),n.on("user-status",e=>{let{userId:t,status:r}=e;k(e=>{let s=new Set(e);return"online"===r?s.add(t):s.delete(t),s})}),n.on("error",e=>{console.error("Socket error:",e),v(e.message)}),O()}else R.push("/login");return()=>{I&&I.disconnect()}},[R]),(0,n.useEffect)(()=>{A()},[m]);let A=()=>{var e;null===(e=E.current)||void 0===e||e.scrollIntoView({behavior:"smooth"})},O=async()=>{try{if(window.location.hostname.includes("vercel.app")){console.log("Using mock chat list for Vercel environment");let e=[{id:"1",title:"新商品コスメのPRキャンペーン",status:"IN_PROGRESS",matchedInfluencer:{user:{id:"inf1",email:"tanaka@example.com"},displayName:"田中美咲"},messages:[{id:"msg1",content:"プロジェクトに参加させていただきありがとうございます！",createdAt:new Date(Date.now()-36e5).toISOString(),senderId:"inf1",receiverId:"current-user",isRead:!0,sender:{id:"inf1",role:"INFLUENCER"}}],unreadCount:0},{id:"2",title:"ライフスタイル商品のレビュー",status:"IN_PROGRESS",matchedInfluencer:{user:{id:"inf2",email:"suzuki@example.com"},displayName:"鈴木さやか"},messages:[{id:"msg2",content:"商品サンプルはいつ頃届きますでしょうか？",createdAt:new Date(Date.now()-72e5).toISOString(),senderId:"inf2",receiverId:"current-user",isRead:!1,sender:{id:"inf2",role:"INFLUENCER"}}],unreadCount:1}];i(e),p(!1);return}let e=localStorage.getItem("token"),t=await fetch("".concat("http://localhost:10000/api","/api/chat/chats"),{headers:{Authorization:"Bearer ".concat(e),"Content-Type":"application/json"}});if(!t.ok)throw Error("Failed to fetch chat list");let r=await t.json();i(r)}catch(e){console.error("Error fetching chat list:",e),v("チャット一覧の取得に失敗しました。")}finally{p(!1)}},_=async e=>{try{if(window.location.hostname.includes("vercel.app")){console.log("Using mock messages for Vercel environment, projectId:",e);let t={1:[{id:"msg1-1",content:"プロジェクトに参加させていただきありがとうございます！",createdAt:new Date(Date.now()-36e5).toISOString(),senderId:"inf1",receiverId:"current-user",isRead:!0,sender:{id:"inf1",role:"INFLUENCER"}},{id:"msg1-2",content:"こちらこそよろしくお願いします。まずは商品について詳しく教えてください。",createdAt:new Date(Date.now()-3e6).toISOString(),senderId:"current-user",receiverId:"inf1",isRead:!0,sender:{id:"current-user",role:"COMPANY"}},{id:"msg1-3",content:"新商品のファンデーションは自然な仕上がりが特徴で、20-30代の女性に人気です。来週サンプルをお送りします。",createdAt:new Date(Date.now()-18e5).toISOString(),senderId:"current-user",receiverId:"inf1",isRead:!0,sender:{id:"current-user",role:"COMPANY"}}],2:[{id:"msg2-1",content:"ライフスタイル商品のレビューは得意分野です。どのような商品でしょうか？",createdAt:new Date(Date.now()-72e5).toISOString(),senderId:"inf2",receiverId:"current-user",isRead:!0,sender:{id:"inf2",role:"INFLUENCER"}},{id:"msg2-2",content:"商品サンプルはいつ頃届きますでしょうか？",createdAt:new Date(Date.now()-36e5).toISOString(),senderId:"inf2",receiverId:"current-user",isRead:!1,sender:{id:"inf2",role:"INFLUENCER"}}]}[e]||[];x(t),i(t=>t.map(t=>t.id===e?{...t,unreadCount:0}:t));return}let t=localStorage.getItem("token"),r=await fetch("".concat("http://localhost:10000/api","/api/chat/messages/").concat(e),{headers:{Authorization:"Bearer ".concat(t),"Content-Type":"application/json"}});if(!r.ok)throw Error("Failed to fetch messages");let s=await r.json();x(s.messages||s),I&&I.emit("mark-messages-read",e),i(t=>t.map(t=>t.id===e?{...t,unreadCount:0}:t))}catch(e){console.error("Error fetching messages:",e),v("メッセージの取得に失敗しました。")}},T=e=>{u(e),_(e.id),I&&I.emit("join-project",e.id)},L=t=>(null==e?void 0:e.role)==="CLIENT"?t.matchedInfluencer:t.client,F=t=>{let r=L(t);return(null==e?void 0:e.role)==="CLIENT"?(null==r?void 0:r.displayName)||"インフルエンサー":(null==r?void 0:r.companyName)||"企業"},M=e=>{let t=new Date(e),r=new Date().getTime()-t.getTime(),s=Math.floor(r/6e4),n=Math.floor(r/36e5),a=Math.floor(r/864e5);return a>0?"".concat(a,"日前"):n>0?"".concat(n,"時間前"):s>0?"".concat(s,"分前"):"たった今"},P=e=>{let t=L(e);return t&&C.has(t.user.id)};return g?(0,s.jsx)("div",{className:"min-h-screen bg-gradient-to-br from-blue-50 via-purple-50 to-pink-50 flex items-center justify-center",children:(0,s.jsxs)("div",{className:"text-center",children:[(0,s.jsx)("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-blue-500 mx-auto mb-4"}),(0,s.jsx)("p",{className:"text-gray-600",children:"読み込み中..."})]})}):(0,s.jsxs)("div",{className:"min-h-screen bg-gradient-to-br from-blue-50 via-purple-50 to-pink-50",children:[(0,s.jsx)("div",{className:"bg-white/80 backdrop-blur-xl border-b border-gray-200 sticky top-0 z-10",children:(0,s.jsxs)("div",{className:"max-w-7xl mx-auto px-4 py-4 flex items-center justify-between",children:[(0,s.jsxs)("div",{className:"flex items-center space-x-4",children:[(0,s.jsx)(d(),{href:"/dashboard",className:"w-10 h-10 bg-gradient-to-r from-blue-500 to-purple-500 rounded-xl flex items-center justify-center",children:(0,s.jsx)("span",{className:"text-white font-bold",children:"IM"})}),(0,s.jsxs)("button",{onClick:()=>R.push("/dashboard"),className:"flex items-center space-x-2 px-4 py-2 bg-white/80 backdrop-blur-xl rounded-xl shadow-lg hover:shadow-xl transition-all text-gray-700 hover:text-blue-600",children:[(0,s.jsx)("svg",{className:"w-5 h-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,s.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M10 19l-7-7m0 0l7-7m-7 7h18"})}),(0,s.jsx)("span",{className:"font-medium",children:"ダッシュボードに戻る"})]}),(0,s.jsxs)("div",{children:[(0,s.jsx)("h1",{className:"text-xl font-bold text-gray-900",children:"チャット"}),(0,s.jsx)("p",{className:"text-sm text-gray-600",children:"プロジェクトメンバーとの会話"})]})]}),(0,s.jsxs)("div",{className:"flex items-center space-x-4",children:[(0,s.jsx)("span",{className:"text-gray-700",children:null==e?void 0:e.email}),(0,s.jsx)(d(),{href:"/dashboard",className:"px-4 py-2 text-gray-600 hover:text-blue-600 transition-colors",children:"ダッシュボード"})]})]})}),b&&(0,s.jsx)(a.E.div,{initial:{opacity:0,y:-10},animate:{opacity:1,y:0},className:"max-w-7xl mx-auto px-4 py-2",children:(0,s.jsx)("div",{className:"bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-xl",children:b})}),(0,s.jsx)("div",{className:"max-w-7xl mx-auto px-4 py-8",children:(0,s.jsxs)("div",{className:"flex h-[600px] bg-white/80 backdrop-blur-xl border border-gray-200 rounded-3xl shadow-xl overflow-hidden",children:[(0,s.jsxs)("div",{className:"w-1/3 border-r border-gray-200 flex flex-col",children:[(0,s.jsx)("div",{className:"p-4 border-b border-gray-200",children:(0,s.jsx)("h2",{className:"text-lg font-bold text-gray-900",children:"チャット一覧"})}),(0,s.jsx)("div",{className:"flex-1 overflow-y-auto",children:0===r.length?(0,s.jsxs)("div",{className:"p-8 text-center text-gray-500",children:[(0,s.jsx)("div",{className:"text-4xl mb-4",children:"\uD83D\uDCAC"}),(0,s.jsx)("p",{children:"チャットがありません"})]}):r.map(e=>(0,s.jsxs)(a.E.div,{whileHover:{backgroundColor:"#f8fafc"},onClick:()=>T(e),className:"p-4 cursor-pointer border-b border-gray-100 ".concat((null==c?void 0:c.id)===e.id?"bg-blue-50 border-blue-200":""),children:[(0,s.jsxs)("div",{className:"flex items-center justify-between mb-2",children:[(0,s.jsxs)("div",{className:"flex items-center space-x-3",children:[(0,s.jsxs)("div",{className:"relative",children:[(0,s.jsx)("div",{className:"w-10 h-10 bg-gradient-to-r from-blue-500 to-purple-500 rounded-full flex items-center justify-center",children:(0,s.jsx)("span",{className:"text-white font-bold",children:F(e).charAt(0)})}),P(e)&&(0,s.jsx)("div",{className:"absolute -bottom-1 -right-1 w-4 h-4 bg-green-500 rounded-full border-2 border-white"})]}),(0,s.jsxs)("div",{className:"flex-1 min-w-0",children:[(0,s.jsx)("h3",{className:"font-semibold text-gray-900 truncate",children:F(e)}),(0,s.jsx)("p",{className:"text-sm text-gray-500 truncate",children:e.title})]})]}),e.unreadCount>0&&(0,s.jsx)("div",{className:"w-6 h-6 bg-red-500 text-white rounded-full flex items-center justify-center text-xs font-bold",children:e.unreadCount})]}),e.messages.length>0&&(0,s.jsx)("div",{className:"text-sm text-gray-600 truncate",children:e.messages[0].content})]},e.id))})]}),(0,s.jsx)("div",{className:"flex-1 flex flex-col",children:c?(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)("div",{className:"p-4 border-b border-gray-200 bg-gray-50",children:(0,s.jsxs)("div",{className:"flex items-center space-x-3",children:[(0,s.jsxs)("div",{className:"relative",children:[(0,s.jsx)("div",{className:"w-10 h-10 bg-gradient-to-r from-blue-500 to-purple-500 rounded-full flex items-center justify-center",children:(0,s.jsx)("span",{className:"text-white font-bold",children:F(c).charAt(0)})}),P(c)&&(0,s.jsx)("div",{className:"absolute -bottom-1 -right-1 w-4 h-4 bg-green-500 rounded-full border-2 border-white"})]}),(0,s.jsxs)("div",{children:[(0,s.jsx)("h3",{className:"font-semibold text-gray-900",children:F(c)}),(0,s.jsx)("p",{className:"text-sm text-gray-500",children:c.title})]})]})}),(0,s.jsxs)("div",{className:"flex-1 overflow-y-auto p-4 space-y-4",children:[m.map(t=>(0,s.jsx)("div",{className:"flex ".concat(t.senderId===(null==e?void 0:e.id)?"justify-end":"justify-start"),children:(0,s.jsxs)("div",{className:"max-w-xs lg:max-w-md px-4 py-2 rounded-2xl ".concat(t.senderId===(null==e?void 0:e.id)?"bg-blue-500 text-white":"bg-gray-200 text-gray-900"),children:[(0,s.jsx)("p",{className:"text-sm",children:t.content}),(0,s.jsxs)("div",{className:"flex items-center justify-between mt-1 text-xs opacity-75",children:[(0,s.jsx)("span",{children:M(t.createdAt)}),t.senderId===(null==e?void 0:e.id)&&(0,s.jsx)("span",{children:t.isRead?"既読":"未読"})]})]})},t.id)),w&&(0,s.jsx)("div",{className:"flex justify-start",children:(0,s.jsx)("div",{className:"bg-gray-200 text-gray-900 px-4 py-2 rounded-2xl",children:(0,s.jsxs)("div",{className:"flex space-x-1",children:[(0,s.jsx)("div",{className:"w-2 h-2 bg-gray-500 rounded-full animate-bounce"}),(0,s.jsx)("div",{className:"w-2 h-2 bg-gray-500 rounded-full animate-bounce",style:{animationDelay:"0.1s"}}),(0,s.jsx)("div",{className:"w-2 h-2 bg-gray-500 rounded-full animate-bounce",style:{animationDelay:"0.2s"}})]})})}),(0,s.jsx)("div",{ref:E})]}),(0,s.jsx)("div",{className:"p-4 border-t border-gray-200",children:(0,s.jsxs)("form",{onSubmit:e=>{if(e.preventDefault(),!h.trim()||!c)return;if(window.location.hostname.includes("vercel.app")){var t;console.log("Using mock send message for Vercel environment");let e={id:"msg-"+Date.now(),content:h.trim(),createdAt:new Date().toISOString(),senderId:"current-user",receiverId:(null===(t=c.matchedInfluencer)||void 0===t?void 0:t.user.id)||"other-user",isRead:!1,sender:{id:"current-user",role:"COMPANY"}};x(t=>[...t,e]),f(""),N(!1);return}if(!I)return;let r={projectId:c.id,content:h.trim()};I.emit("send-message",r),f(""),N(!1)},className:"flex space-x-2",children:[(0,s.jsx)("input",{type:"text",value:h,onChange:e=>{f(e.target.value),!j&&I&&c&&(N(!0),I.emit("typing-start",c.id)),D.current&&clearTimeout(D.current),D.current=setTimeout(()=>{I&&c&&(I.emit("typing-stop",c.id),N(!1))},1e3)},placeholder:"メッセージを入力...",className:"flex-1 px-4 py-2 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"}),(0,s.jsx)(a.E.button,{whileHover:{scale:1.05},whileTap:{scale:.95},type:"submit",disabled:!h.trim(),className:"px-6 py-2 bg-blue-500 text-white rounded-xl font-semibold hover:bg-blue-600 transition-colors disabled:opacity-50 disabled:cursor-not-allowed",children:"送信"})]})})]}):(0,s.jsx)("div",{className:"flex-1 flex items-center justify-center",children:(0,s.jsxs)("div",{className:"text-center text-gray-500",children:[(0,s.jsx)("div",{className:"text-6xl mb-4",children:"\uD83D\uDCAC"}),(0,s.jsx)("h3",{className:"text-xl font-semibold mb-2",children:"チャットを選択してください"}),(0,s.jsx)("p",{children:"左側のリストからチャットを選んで会話を始めましょう"})]})})})]})})]})}}},function(e){e.O(0,[5841,1664,3900,2888,9774,179],function(){return e(e.s=22)}),_N_E=e.O()}]);