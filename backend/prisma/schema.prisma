generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

enum UserRole {
  COMPANY
  CLIENT
  INFLUENCER
  ADMIN
}

enum UserStatus {
  PROVISIONAL // 仮登録（メール認証完了）
  VERIFICATION_PENDING // 本人確認待ち（書類提出済み）
  VERIFIED // 本人確認完了
  SUSPENDED // 停止中
  DELETED // 削除済み
}

enum VerificationStatus {
  PENDING // 審査待ち
  APPROVED // 承認
  REJECTED // 却下
  RESUBMIT_REQUIRED // 再提出が必要
}

enum DocumentType {
  BUSINESS_REGISTRATION // 登記簿謄本（企業用）
  ID_DOCUMENT // 身分証明書（インフルエンサー用）
  INVOICE_DOCUMENT // インボイス書類
}

enum VerificationType {
  EMAIL // メール認証
  DOCUMENT // 書類認証
  SNS // SNS認証
  IDENTITY // 本人確認（インフルエンサー）
  BUSINESS // 事業者確認（企業）
}

enum Platform {
  INSTAGRAM
  YOUTUBE
  TIKTOK
  TWITTER
  FACEBOOK
}

enum ProjectStatus {
  PENDING
  MATCHED
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

enum AchievementPurpose {
  SALES // 売上目的
  LEAD_GEN // 集客目的
  AWARENESS // 認知拡大目的
  BRAND_IMAGE // ブランドイメージ向上
  ENGAGEMENT // エンゲージメント向上
}

enum ServiceType {
  PHOTOGRAPHY // 撮影
  VIDEO_EDITING // 動画編集
  CONTENT_CREATION // コンテンツ制作
  POSTING // 投稿
  STORY_CREATION // ストーリー制作
  CONSULTATION // コンサルティング
  LIVE_STREAMING // ライブ配信
  EVENT_APPEARANCE // イベント出演
}

enum InquiryStatus {
  PENDING // 返答待ち
  ACCEPTED // 承諾
  DECLINED // 辞退
  EXPIRED // 期限切れ
}

enum MilestoneType {
  VIDEO_COMPLETION // 動画完成
  FINAL_APPROVAL // 最終承認
  PUBLISH_DATE // 投稿日
}

enum Gender {
  MALE
  FEMALE
  OTHER
  NOT_SPECIFIED
}

model User {
  id              String     @id @default(cuid())
  email           String     @unique
  password        String
  role            UserRole
  status          UserStatus @default(PROVISIONAL)
  isVerified      Boolean    @default(false)
  emailVerifiedAt DateTime?
  lastLoginAt     DateTime?
  createdAt       DateTime   @default(now())
  updatedAt       DateTime   @updatedAt

  // Relations
  company             Company?
  client              Client?
  influencer          Influencer?
  teamMembers         TeamMember[]
  sentMessages        Message[]                @relation("sender")
  receivedMessages    Message[]                @relation("receiver")
  notifications       Notification[]
  reviewsGiven        Review[]                 @relation("ReviewGiven")
  reviewsReceived     Review[]                 @relation("ReviewReceived")
  securityLogs        SecurityLog[]
  verificationRecords VerificationRecord[]
  emailTokens         EmailVerificationToken[]
}

// 企業プロフィール（Chapter 1 - ユーザー登録・審査）
model Company {
  id                 String     @id @default(cuid())
  userId             String     @unique
  companyName        String
  legalNumber        String? // 法人番号
  representativeName String?
  industry           String?
  address            String?
  phoneNumber        String?
  logoUrl            String?
  isVerified         Boolean    @default(false)
  verifiedAt         DateTime?
  status             UserStatus @default(PROVISIONAL)
  createdAt          DateTime   @default(now())
  updatedAt          DateTime   @updatedAt

  // Relations
  user                  User                   @relation(fields: [userId], references: [id], onDelete: Cascade)
  bankAccounts          BankAccount[]
  verificationDocuments VerificationDocument[]

  @@index([userId])
  @@index([isVerified])
}

// インフルエンサーの銀行口座情報
model BankAccount {
  id            String   @id @default(cuid())
  companyId     String?
  influencerId  String?
  accountHolder String
  bankName      String
  branchName    String
  accountNumber String
  accountType   String // CHECKING, SAVINGS
  isDefault     Boolean  @default(false)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relations
  company    Company?    @relation(fields: [companyId], references: [id], onDelete: Cascade)
  influencer Influencer? @relation(fields: [influencerId], references: [id], onDelete: Cascade)

  @@index([companyId])
  @@index([influencerId])
}

model Client {
  id           String   @id @default(cuid())
  userId       String   @unique
  companyName  String
  industry     String?
  contactName  String
  contactPhone String?
  address      String?
  teamId       String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relations
  user          User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  team          Team?         @relation(fields: [teamId], references: [id])
  projects      Project[]
  applications  Application[]
  submissions   Submission[]
  reviews       Review[]
  bulkInquiries BulkInquiry[]
}

model Influencer {
  id           String    @id @default(cuid())
  userId       String    @unique
  displayName  String
  bio          String?
  gender       Gender    @default(NOT_SPECIFIED)
  birthDate    DateTime?
  phoneNumber  String?
  address      String?
  prefecture   String?
  city         String?
  categories   String[] // 美容、ファッション、グルメなど
  priceMin     Int? // 最低単価（円）
  priceMax     Int? // 最高単価（円）
  isRegistered Boolean   @default(false)
  lastUpdated  DateTime  @default(now())
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  // Relations
  user                  User                   @relation(fields: [userId], references: [id], onDelete: Cascade)
  socialAccounts        SocialAccount[]
  applications          Application[]
  projects              Project[]
  portfolio             Portfolio[]
  submissions           Submission[]
  reviews               Review[]
  achievements          Achievement[]
  servicePricing        ServicePricing[]
  inquiryResponses      InquiryResponse[]
  bankAccounts          BankAccount[]
  verificationDocuments VerificationDocument[]
}

model SocialAccount {
  id             String   @id @default(cuid())
  influencerId   String
  platform       Platform
  username       String
  profileUrl     String
  followerCount  Int      @default(0)
  engagementRate Float? // エンゲージメント率（%）
  isVerified     Boolean  @default(false)
  isConnected    Boolean  @default(false) // OAuth連携済みフラグ
  lastSynced     DateTime @default(now())
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  // OAuth関連
  accessToken    String? // 暗号化して保存
  refreshToken   String? // 暗号化して保存
  tokenExpiresAt DateTime? // トークンの有効期限
  platformUserId String? // SNSプラットフォーム側のユーザーID

  // Relations
  influencer Influencer @relation(fields: [influencerId], references: [id], onDelete: Cascade)

  @@unique([influencerId, platform])
}

model Team {
  id        String   @id @default(cuid())
  name      String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  members TeamMember[]
  clients Client[]
}

model TeamMember {
  id       String   @id @default(cuid())
  teamId   String
  userId   String
  isOwner  Boolean  @default(false)
  joinedAt DateTime @default(now())

  // Relations
  team Team @relation(fields: [teamId], references: [id], onDelete: Cascade)
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([teamId, userId])
}

model Project {
  id                String        @id @default(cuid())
  clientId          String
  title             String
  description       String
  category          String
  budget            Int
  targetPlatforms   Platform[]
  targetPrefecture  String?
  targetCity        String?
  targetGender      Gender?
  targetAgeMin      Int?
  targetAgeMax      Int?
  targetFollowerMin Int?
  targetFollowerMax Int?
  status            ProjectStatus @default(PENDING)
  startDate         DateTime?
  endDate           DateTime?
  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt

  // 追加情報（企業が登録する詳細）
  advertiserName     String?
  brandName          String?
  productName        String?
  productUrl         String?
  productPrice       Int?
  productFeatures    String?
  campaignObjective  String?
  campaignTarget     String?
  postingPeriodStart DateTime?
  postingPeriodEnd   DateTime?
  postingMedia       String[]  @default([])
  messageToConvey    String?
  shootingAngle      String?
  packagePhotography String?
  referenceUrl       String?
  prohibitedMatters  String?
  hashtagInstruction String?
  mentionInstruction String?
  remarks            String?

  // Relations
  client              Client           @relation(fields: [clientId], references: [id])
  applications        Application[]
  matchedInfluencer   Influencer?      @relation(fields: [matchedInfluencerId], references: [id])
  matchedInfluencerId String?
  messages            Message[]
  transaction         Transaction?
  submissions         Submission[]
  reviews             Review[]
  schedule            ProjectSchedule?
}

model Application {
  id            String   @id @default(cuid())
  projectId     String
  influencerId  String
  clientId      String
  message       String?
  proposedPrice Int?
  isAccepted    Boolean  @default(false)
  appliedAt     DateTime @default(now())

  // Relations
  project    Project    @relation(fields: [projectId], references: [id])
  influencer Influencer @relation(fields: [influencerId], references: [id])
  client     Client     @relation(fields: [clientId], references: [id])

  @@unique([projectId, influencerId])
}

model Message {
  id         String   @id @default(cuid())
  projectId  String
  senderId   String
  receiverId String
  content    String
  isRead     Boolean  @default(false)
  createdAt  DateTime @default(now())

  // Relations
  project  Project @relation(fields: [projectId], references: [id])
  sender   User    @relation("sender", fields: [senderId], references: [id])
  receiver User    @relation("receiver", fields: [receiverId], references: [id])
}

model Transaction {
  id              String   @id @default(cuid())
  projectId       String   @unique
  amount          Int // 金額（円）
  fee             Int // 手数料（円）
  stripePaymentId String   @unique
  status          String // pending, completed, failed, refunded
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  project Project @relation(fields: [projectId], references: [id])
}

model Submission {
  id              String    @id @default(cuid())
  projectId       String
  influencerId    String
  clientId        String
  submissionUrl   String // URL to submitted content/video
  submissionType  String // video, image, content, post, etc
  submissionNotes String? // Notes or description from influencer
  status          String    @default("PENDING") // PENDING, APPROVED, REVISION_REQUESTED, REJECTED
  approvalNotes   String? // Company notes on approval/rejection
  submittedAt     DateTime  @default(now())
  approvedAt      DateTime?
  updatedAt       DateTime  @updatedAt

  // Relations
  project    Project    @relation(fields: [projectId], references: [id])
  influencer Influencer @relation(fields: [influencerId], references: [id])
  client     Client     @relation(fields: [clientId], references: [id])

  @@index([projectId])
  @@index([influencerId])
  @@index([clientId])
}

model Portfolio {
  id           String    @id @default(cuid())
  influencerId String
  title        String
  description  String?
  imageUrl     String?
  link         String?
  platform     Platform?
  createdAt    DateTime  @default(now())

  // Relations
  influencer Influencer @relation(fields: [influencerId], references: [id], onDelete: Cascade)
}

enum NotificationType {
  APPLICATION_RECEIVED
  APPLICATION_ACCEPTED
  APPLICATION_REJECTED
  PROJECT_MATCHED
  MESSAGE_RECEIVED
  PAYMENT_COMPLETED
  PROJECT_STATUS_CHANGED
  TEAM_INVITATION
  SYSTEM_ANNOUNCEMENT
}

model Notification {
  id        String           @id @default(cuid())
  userId    String
  type      NotificationType
  title     String
  message   String
  isRead    Boolean          @default(false)
  data      Json? // Additional data for the notification
  createdAt DateTime         @default(now())
  readAt    DateTime?

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, isRead])
  @@index([userId, createdAt])
}

model Review {
  id           String   @id @default(cuid())
  projectId    String
  reviewerId   String // User who gives the review
  revieweeId   String // User being reviewed (influencer or client)
  influencerId String? // If reviewing influencer
  clientId     String? // If reviewing client
  rating       Int // 1-5 stars
  comment      String?
  isPublic     Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relations
  project    Project     @relation(fields: [projectId], references: [id], onDelete: Cascade)
  reviewer   User        @relation("ReviewGiven", fields: [reviewerId], references: [id], onDelete: Cascade)
  reviewee   User        @relation("ReviewReceived", fields: [revieweeId], references: [id], onDelete: Cascade)
  influencer Influencer? @relation(fields: [influencerId], references: [id], onDelete: Cascade)
  client     Client?     @relation(fields: [clientId], references: [id], onDelete: Cascade)

  @@unique([projectId, reviewerId]) // One review per project per reviewer
  @@index([revieweeId, rating])
  @@index([influencerId, rating])
  @@index([clientId, rating])
}

// v3.0 新機能: インフルエンサー実績管理
model Achievement {
  id           String             @id @default(cuid())
  influencerId String
  projectName  String
  brandName    String
  purpose      AchievementPurpose
  platform     Platform
  description  String?
  metrics      Json? // 成果指標: {views: 1000, likes: 100, shares: 50, conversions: 5}
  budget       Int? // 予算
  duration     String? // 実施期間
  imageUrl     String? // 実績画像
  link         String? // 実績URL
  createdAt    DateTime           @default(now())
  updatedAt    DateTime           @updatedAt

  // Relations
  influencer Influencer @relation(fields: [influencerId], references: [id], onDelete: Cascade)

  @@index([influencerId, purpose])
  @@index([platform, purpose])
}

// v3.0 新機能: インフルエンサー料金体系
model ServicePricing {
  id           String      @id @default(cuid())
  influencerId String
  serviceType  ServiceType
  price        Int // 料金（円）
  unit         String      @default("per_post") // 単位: per_post, per_hour, per_day
  description  String?
  isActive     Boolean     @default(true)
  createdAt    DateTime    @default(now())
  updatedAt    DateTime    @updatedAt

  // Relations
  influencer Influencer @relation(fields: [influencerId], references: [id], onDelete: Cascade)

  @@unique([influencerId, serviceType])
  @@index([influencerId, isActive])
}

// v3.0 新機能: 一斉問い合わせ
model BulkInquiry {
  id               String        @id @default(cuid())
  clientId         String
  title            String
  description      String
  budget           Int?
  deadline         DateTime?
  requiredServices ServiceType[]
  createdAt        DateTime      @default(now())
  updatedAt        DateTime      @updatedAt

  // Relations
  client    Client            @relation(fields: [clientId], references: [id], onDelete: Cascade)
  responses InquiryResponse[]

  @@index([clientId, createdAt])
}

// v3.0 新機能: 問い合わせ回答
model InquiryResponse {
  id            String        @id @default(cuid())
  inquiryId     String
  influencerId  String
  status        InquiryStatus @default(PENDING)
  proposedPrice Int?
  message       String?
  availableFrom DateTime?
  availableTo   DateTime?
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  // Relations
  inquiry    BulkInquiry @relation(fields: [inquiryId], references: [id], onDelete: Cascade)
  influencer Influencer  @relation(fields: [influencerId], references: [id], onDelete: Cascade)

  @@unique([inquiryId, influencerId])
  @@index([inquiryId, status])
  @@index([influencerId, status])
}

// v3.0 新機能: スケジュール管理
model ProjectSchedule {
  id          String   @id @default(cuid())
  projectId   String   @unique
  publishDate DateTime // 投稿日
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  project    Project     @relation(fields: [projectId], references: [id], onDelete: Cascade)
  milestones Milestone[]

  @@index([publishDate])
}

// v3.0 新機能: マイルストーン管理
model Milestone {
  id               String        @id @default(cuid())
  scheduleId       String
  type             MilestoneType
  title            String
  description      String?
  dueDate          DateTime
  isCompleted      Boolean       @default(false)
  completedAt      DateTime?
  notificationSent Boolean       @default(false)
  createdAt        DateTime      @default(now())
  updatedAt        DateTime      @updatedAt

  // Relations
  schedule ProjectSchedule @relation(fields: [scheduleId], references: [id], onDelete: Cascade)

  @@index([scheduleId, dueDate])
  @@index([dueDate, isCompleted])
  @@index([dueDate, notificationSent])
}

// Chapter 1: ユーザー登録・審査（メール認証）
model EmailVerificationToken {
  id        String    @id @default(cuid())
  userId    String
  token     String    @unique
  expiresAt DateTime
  usedAt    DateTime?
  createdAt DateTime  @default(now())

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, expiresAt])
  @@index([token])
}

// Chapter 1: 本人確認（書類認証）
model VerificationDocument {
  id              String             @id @default(cuid())
  companyId       String?
  influencerId    String?
  documentType    DocumentType
  documentUrl     String // S3 URL
  fileName        String?
  fileSize        Int? // ファイルサイズ（バイト）
  status          VerificationStatus @default(PENDING)
  rejectionReason String? // 却下理由
  uploadedAt      DateTime           @default(now())
  reviewedAt      DateTime?
  createdAt       DateTime           @default(now())
  updatedAt       DateTime           @updatedAt

  // Relations
  company    Company?    @relation(fields: [companyId], references: [id], onDelete: Cascade)
  influencer Influencer? @relation(fields: [influencerId], references: [id], onDelete: Cascade)

  @@index([companyId, status])
  @@index([influencerId, status])
  @@index([documentType, status])
}

// 包括的な認証記録（メール、書類、SNS認証を追跡）
model VerificationRecord {
  id         String             @id @default(cuid())
  userId     String
  type       VerificationType
  status     VerificationStatus @default(PENDING)
  verifiedAt DateTime?
  expiresAt  DateTime?
  metadata   Json? // SNS認証の場合はplatform, username, followerCountなど
  createdAt  DateTime           @default(now())
  updatedAt  DateTime           @updatedAt

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, type])
  @@index([userId, type, status])
  @@index([type, status])
}

// セキュリティログ管理
enum SecurityEventType {
  XSS_ATTACK
  SQL_INJECTION
  COMMAND_INJECTION
  CSRF_ATTACK
  BRUTE_FORCE
  SUSPICIOUS_ACTIVITY
  CSP_VIOLATION
  AUTHENTICATION_FAILURE
  AUTHORIZATION_FAILURE
  DATA_BREACH_ATTEMPT
  MALWARE_UPLOAD
  RATE_LIMIT_EXCEEDED
}

enum SecuritySeverity {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

enum SecurityStatus {
  DETECTED
  INVESTIGATING
  RESOLVED
  FALSE_POSITIVE
  IGNORED
}

// セキュリティインシデントログ
model SecurityLog {
  id        String            @id @default(cuid())
  eventType SecurityEventType
  severity  SecuritySeverity
  status    SecurityStatus    @default(DETECTED)

  // 攻撃者情報
  ipAddress String
  userAgent String?
  userId    String?
  sessionId String?

  // リクエスト情報
  url     String
  method  String  @default("GET")
  headers Json?
  payload String? // 攻撃ペイロード（部分的）

  // 検出情報
  detectionEngine  String @default("XSS_ENGINE")
  confidence       Int    @default(0) // 0-100
  riskScore        Int    @default(0) // 0-100
  detectedPatterns Json? // 検出されたパターン

  // 地理的情報
  country String?
  region  String?
  city    String?

  // タイムスタンプ
  detectedAt DateTime  @default(now())
  resolvedAt DateTime?
  updatedAt  DateTime  @updatedAt

  // 関連情報
  incidentId  String? // 関連インシデントID
  parentLogId String? // 親ログID（関連攻撃）

  // アクション
  actionTaken String? // 実行されたアクション
  blocked     Boolean @default(false)
  notified    Boolean @default(false)

  // メタデータ
  metadata Json? // 追加情報
  notes    String? // 管理者メモ

  // Relations
  user      User?         @relation(fields: [userId], references: [id])
  parentLog SecurityLog?  @relation("SecurityLogHierarchy", fields: [parentLogId], references: [id])
  childLogs SecurityLog[] @relation("SecurityLogHierarchy")

  @@index([eventType, detectedAt])
  @@index([severity, detectedAt])
  @@index([ipAddress, detectedAt])
  @@index([userId, detectedAt])
  @@index([status, detectedAt])
  @@index([incidentId])
  @@index([detectedAt])
}

// セキュリティ統計情報（日次集計）
model SecurityStats {
  id   String   @id @default(cuid())
  date DateTime @unique @db.Date

  // 攻撃統計
  totalAttacks  Int @default(0)
  xssAttacks    Int @default(0)
  sqlInjections Int @default(0)
  bruteForce    Int @default(0)
  otherAttacks  Int @default(0)

  // 重要度別統計
  criticalEvents Int @default(0)
  highEvents     Int @default(0)
  mediumEvents   Int @default(0)
  lowEvents      Int @default(0)

  // 地理的統計
  topCountries Json? // 攻撃元上位国
  topRegions   Json? // 攻撃元上位地域

  // IP統計
  uniqueIPs      Int   @default(0)
  blockedIPs     Int   @default(0)
  topAttackerIPs Json? // 上位攻撃者IP

  // ユーザー統計
  affectedUsers   Int   @default(0)
  suspiciousUsers Json? // 疑わしいユーザー

  // システム統計
  avgResponseTime   Float? // 平均検出時間
  falsePositives    Int    @default(0)
  resolvedIncidents Int    @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([date])
}

// IPアドレスブラックリスト
model IPBlacklist {
  id        String  @id @default(cuid())
  ipAddress String  @unique
  cidr      String? // CIDR notation for IP ranges

  // ブロック理由
  reason        String
  severity      SecuritySeverity
  firstDetected DateTime
  lastActivity  DateTime

  // 統計情報
  attackCount     Int @default(1)
  blockedRequests Int @default(0)

  // ブロック設定
  isActive  Boolean   @default(true)
  expiresAt DateTime? // 自動解除日時
  permanent Boolean   @default(false)

  // 地理的情報
  country String?
  region  String?
  asn     String? // Autonomous System Number
  isp     String?

  // 管理情報
  addedBy String? // 追加した管理者ID
  notes   String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([ipAddress])
  @@index([isActive, expiresAt])
  @@index([country])
  @@index([lastActivity])
}

// セキュリティルール管理
model SecurityRule {
  id          String  @id @default(cuid())
  name        String  @unique
  description String?

  // ルール定義
  ruleType   SecurityEventType
  pattern    String // 検出パターン (正規表現等)
  severity   SecuritySeverity
  confidence Int               @default(50) // 0-100

  // ルール設定
  isActive   Boolean @default(true)
  autoBlock  Boolean @default(false)
  autoNotify Boolean @default(true)

  // 統計情報
  matchCount     Int       @default(0)
  falsePositives Int       @default(0)
  lastMatched    DateTime?

  // 管理情報
  createdBy String? // 作成者ID
  version   Int     @default(1)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([ruleType, isActive])
  @@index([isActive, severity])
}
